{% extends "admin/admin_base.html" %}


{% block head %}
<!-- sweet alert framework -->
<link rel="stylesheet" type="text/css"
    href="{{url_for('bp_admin.static', filename='bower_components/sweetalert/css/sweetalert.css')}}">
{% endblock %}


{% block scripts %}
<!-- sweet alert js -->
<script type="text/javascript"
    src="{{url_for('bp_admin.static', filename='bower_components/sweetalert/js/sweetalert.min.js')}}"></script>
<script type="text/javascript" src="{{url_for('bp_admin.static', filename='js/modal.js')}}"></script>
<script>
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
            }
        }
    });


    $.validator.setDefaults({
        errorElement: 'span',
        errorPlacement: function (error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
        },
        highlight: function (element, errorClass, validClass) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function (element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
        }
    });


    function clearCreateModal() {
        $(':input', '#mdl_add_fund')
            .not(':button, :submit, :reset, :hidden')
            .val('')
            .prop('checked', false)
            .prop('selected', false);

        $(':input', '#mdl_add_expenses')
            .not(':button, :submit, :reset, :hidden')
            .val('')
            .prop('checked', false)
            .prop('selected', false);
    }


    function getContactPersons(branch, from) {
        var selectDescriptionId = "#description";

        if (from == "filter") {
            selectDescriptionId = "#filter_description";
        } else if (from == "filter_tab3") {
            selectDescriptionId = "#filter_tab3_description";
        }
        $(selectDescriptionId).empty();

        $.getJSON('/learning-management/api/get-branch-contact-persons/' + branch, function (response) {
            if (response.data.length > 0) {
                $(selectDescriptionId).append($('<option value="">Select...</option>'));

                for (i = 0; i < response.data.length; i++) {
                    $(selectDescriptionId).append($(`<option value="${response.data[i].id}">${response.data[i].full_name}</option>`));
                }
            } else {
                $(selectDescriptionId).append($('<option value="">No Contact Persons available</option>'));
            }
        });
    }

    function getEmployees(branch, from) {
        var selectDescriptionId = "#description";

        if (from == "filter") {
            selectDescriptionId = "#filter_description";
        } else if (from == "filter_tab3") {
            selectDescriptionId = "#filter_tab3_description";
        }
        $(selectDescriptionId).empty();
        $.getJSON('/learning-management/fetch-employees?branch=' + branch, function (response) {
            if (response.data.length > 0) {
                $(selectDescriptionId).append(newOption);

                for (i = 0; i < response.data.length; i++) {
                    var newOption = $(`<option value="${response.data[i].id}">${response.data[i].full_name}</option>`);
                    $(selectDescriptionId).append(newOption);
                }
            } else {
                var newOption = $('<option value="">No employees available</option>');
                $(selectDescriptionId).append(newOption);
            }
        });
    }


    $(document).ready(function () {
        $("#li_payroll").addClass('mm-active');

        var dtEmployees = $('#tbl_employees').DataTable({
            "dom": "rtip",
            "pageLength": 25,
            "processing": true,
            "serverSide": true,
            "ordering": false,
            "responsive": true,
            "autoWidth": false,
            "ajax": {
                "url": "/learning-management/datatables/payroll/employees",
                "data": function(d){
                    d.role = $("#filter_roles").val();
                }
            },
            "language": {
                "searchPlaceholder": "By last name",
            },
            initComplete: function () {
                var input = $('.dataTables_filter input').unbind(),
                    self = this.api(),
                    $searchButton = $('<button>')
                        .text('search')
                        .click(function () {
                            self.search(input.val()).draw();
                        }),
                    $clearButton = $('<button>')
                        .text('clear')
                        .click(function () {
                            input.val('');
                            $searchButton.click();
                        })
                $('.dataTables_filter').append($searchButton, $clearButton);
            },
            "columnDefs": [
                {
                    "targets": 0,
                    "visible": false
                },
                {
                    "targets": 1,
                    "className": "text-center",
                },
                {
                    "targets": 2,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="widget-content p-0">
                                <div class="widget-content-wrapper">
                                    <div class="widget-content-left mr-3">
                                        <div class="widget-content-left">
                                            <img width="40" class="rounded-circle" src="/auth/auth/static/img/user_default_image.png" alt=""></div>
                                    </div>
                                    <div class="widget-content-left flex2">
                                        <div class="widget-heading">${data['name']}</div>
                                        <div class="widget-subheading opacity-7">${data['username']}</div>
                                    </div>
                                </div>
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 5,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-salary-rate">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 6,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-ee-sss">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 7,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-ee-phil">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 8,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-ee-pag-ibig">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 9,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-er-sss">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 10,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-er-phil">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 11,
                    "render": function (data, type, row) {
                        return `<td>
                            <div class="position-relative form-group">
                                <input value="${data}" disabled step="any" min=0 type="number" class="form-control inp-er-pag-ibig">
                            </div>
                        </td>`;
                    }
                },
                {
                    "targets": 12,
                    "render": function (data, type, row) {
                        return `
                        <button type="button" class="btn btn-primary btn-sm btn-edit" value="edit"><i class="fa fa-edit"></i></button>
                        `;
                    }
                },
            ],
        });

        $("#tbl_employees tbody").on('click', '.btn-edit', function(){
            let buttonVal = $(this).val(); 
            let row = $(this).parents('tr');
            const userId = dtEmployees.row(row).data()[0];

            if(buttonVal == "edit"){
                $(this).val('save');
                $(this).removeClass('btn-primary');
                $(this).addClass('btn-success');
                $('input', row).each(function() {
                    $(this).prop('disabled', false);
                });
            } else if(buttonVal == "save"){
                $(this).val('edit');
                $(this).removeClass('btn-success');
                $(this).addClass('btn-primary');

                let values = [];

                $('input', row).each(function() {
                    $(this).prop('disabled', true);
                    
                    values.push($(this).val());
                });

                $.ajax({
                    type: "POST",
                    url: `/learning-management/payroll/employees/${userId}/edit`,
                    dataType: "json",
                    data: JSON.stringify({
                        'values': values
                    }),
                    contentType: "application/json; charset=utf-8",
                    success: function (response) {
                        swal("Success!", 'Saved Successfully!', "success");
                    },
                    error: function (data) {
                        swal("Error occured!", "Please refresh the page then try again!", "error");
                    },
                });
            }
        });
    }); // document.ready
</script>
{% endblock %}


{% block content %}
<div class="app-main__inner">
    <div class="app-page-title" style="background-color: skyblue">
        <div class="page-title-wrapper">
            <div class="page-title-heading">
                <div class="page-title-icon">
                    <i class="pe-7s-date icon-gradient bg-happy-itmeo"></i>
                </div>
                <div>
                    Payroll
                    <div class="page-title-subheading">
                        Compensation and Benefits
                    </div>
                </div>
            </div>
            <div class="page-title-actions">
                <a href="{{url_for('lms.create_payslip_page')}}" class="btn-shadow mr-3 btn btn-primary">
                    <i class="fa fa-plus"> New Payslip</i> 
                </a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="main-card mb-3 card">
                <div class="card-body">
                    <div style="margin-top: 10px;" class="table-responsive">
                        <table id="tbl_salary"
                            class="align-middle mb-0 table table-bordered table-striped table-hover">
                            <thead>
                                <tr>
                                    <th class="text-center">DATE</th>
                                    <th class="text-center">NAME OF EMPLOYEE</th>
                                    <th class="text-center">CUT OF DATE</th>
                                    <th class="text-center">GROSS SALARY</th>
                                    <th class="text-center">DEDUCTION</th>
                                    <th class="text-center">NET</th>
                                    <th class="text-center">SETTLED BY</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
