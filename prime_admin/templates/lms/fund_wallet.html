{% extends "admin/admin_base.html" %}


{% block head %}
<!-- sweet alert framework -->
<link rel="stylesheet" type="text/css" href="{{url_for('bp_admin.static', filename='bower_components/sweetalert/css/sweetalert.css')}}">
{% endblock %}


{% block scripts %}
<!-- sweet alert js -->
<script type="text/javascript" src="{{url_for('bp_admin.static', filename='bower_components/sweetalert/js/sweetalert.min.js')}}"></script>
<script type="text/javascript" src="{{url_for('bp_admin.static', filename='js/modal.js')}}"></script>
<script>
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", CSRF_TOKEN);
            }
        }
    });        

    $.validator.setDefaults({
        errorElement: 'span',
        errorPlacement: function (error, element) {
            error.addClass('invalid-feedback');
            element.closest('.form-group').append(error);
        },
        highlight: function (element, errorClass, validClass) {
            $(element).addClass('is-invalid');
        },
        unhighlight: function (element, errorClass, validClass) {
            $(element).removeClass('is-invalid');
        }
    });

    function clearCreateModal(){
        $(':input','#mdl_add_fund')
            .not(':button, :submit, :reset, :hidden')
            .val('')
            .prop('checked', false)
            .prop('selected', false);
    }

    $(document).ready(function(){
        var dtbl_fund_wallet_statements = $("#tbl_fund_wallet_statements").DataTable({
            "dom": 'rtip',
            "processing": true,
            "autoWidth": false,
            "serverSide": true,
            "ajax": {
                "url": "/learning-management/branches/all/fund-wallet-statements/dt",
                "dataSrc": function(json){
                    $("#total_fund_wallet").html("₱" + json.totalFundWallet);
                    return json.data;
                }
            },
            "pageLength": 25,
            "ordering": false,
            "order": [[ 0, 'asc' ]],
            "columnDefs": [
            ],
            "order": [[1, 'asc']],
        });

        $('#frm_add_fund').validate({
            'rules': {
                'branch': {
                    'required': true
                },
                'bank_name': {
                    'required': true,
                },
                'transaction_no': {
                    'required': true
                },
                'sender': {
                    'required': true,
                },
                'amount_received': {
                    'required': true,
                },
                'receiver': {
                    'required': true,
                },
                'remarks': {
                    'required': true,
                },
            },
            'submitHandler': function(form){
                var xform = $(form);

                swal({
                    title: `Add fund to fund wallet?`,
                    text: "Double check your inputted data!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    confirmButtonText: "Confirm!",
                    closeOnConfirm: false,
                    showLoaderOnConfirm: true
                }, function(){
                    setTimeout(function () {
                        $.ajax({
                            type: xform.attr('method'),
                            url: xform.attr('action'),
                            data: xform.serialize(),
                            success: function (response) {
                                event.stopPropagation();

                                dtbl_fund_wallet_statements.ajax.reload();
                                swal("Success!", response.message, "success");
                                $("#mdl_add_fund .close").click()
                                clearCreateModal();
                            },
                            error: function (data) {
                                swal("Error Occured!", "Please refresh the page then try again!", "error");
                            },
                        });
                    }, 500);
                });
            }
        });

        var dtbl_fund_wallet_transactions = $("#tbl_fund_wallet_transactions").DataTable({
            "dom": 'rtip',
            "processing": true,
            "autoWidth": false,
            "serverSide": true,
            "ajax": {
                "url": "/learning-management/api/dtbl/add-funds-transactions",
                "data": function (d) {
                    d.branch = $("#btn_branch_label").val();
                },
                "dataSrc": function(json){
                    $("#total_fund_wallet").html("₱" + json.totalFundWallet);
                    return json.data;
                }
            },
            "pageLength": 25,
            "ordering": false,
            "order": [[ 0, 'asc' ]],
            "columnDefs": [
            ],
            "order": [[1, 'asc']],
        });

        var dtbl_expenses_transactions = $("#tbl_expenses_transactions").DataTable({
            "dom": 'rtip',
            "processing": true,
            "autoWidth": false,
            "serverSide": true,
            "ajax": {
                "url": "/learning-management/api/dtbl/expenses-transactions",
                "data": function (d) {
                    d.branch = $("#btn_branch_label").val();
                },
                "dataSrc": function(json){
                    $("#total_utilities").html("₱" + json.totalUtilities);
                    $("#total_office_supplies").html("₱" + json.totalOfficeSupplies);
                    $("#total_salaries_and_rebates").html("₱" + json.totalSalariesAndRebates);
                    $("#total_other_expenses").html("₱" + json.totalOtherExpenses);
                    return json.data;
                }
            },
            "pageLength": 25,
            "ordering": false,
            "order": [[ 0, 'asc' ]],
            "columnDefs": [
            ],
            "order": [[1, 'asc']],
         });

        $("#btn_branch_label").change(function () {
            const branchId = $("#btn_branch_label").val();

            dtbl_fund_wallet_statements.ajax.url(`/learning-management/branches/${branchId}/fund-wallet-statements/dt`).load();
            dtbl_fund_wallet_transactions.ajax.reload();
            dtbl_expenses_transactions.ajax.reload();
        });

        $("#div_branch_buttons").on('click', '.btn-branch', function () {
            var branch_name = $(this).html();
    
            // if(!(localStorage.getItem('sessSubArea') == _sub_area_name)){
            $("#btn_branch_label").html(branch_name.toUpperCase());
            $("#btn_branch_label").val($(this).val());
            $("#card_header_label").html(branch_name);
    
            $('#btn_branch_label').trigger('change');
            // dtbl_subscribers.ajax.url(`/bds/api/sub-areas/${$(this).val()}/subscribers`).load();
            // }
    
        });


        $("#category").change(function(){
            var selectedCategory = $(this).val();
            $("#description").empty()
            $("#description").append($('<option></option>').attr("value", "").text("Choose category first..."));
            $("#qty").prop('disabled', false);
            $("#unit_price").prop('disabled', false);
            $("#account_no").prop('disabled', false);
            $("#billing_month_from").prop('disabled', false);
            $("#billing_month_to").prop('disabled', false);
            $("#qty").prop('required', true);
            $("#unit_price").prop('required', true);
            $("#account_no").prop('required', true);
            $("#billing_month_from").prop('required', true);
            $("#billing_month_to").prop('required', true);
            $("#label_description").html('Description');
            $("#total_amount_due").prop('readonly', false);

            if(selectedCategory == "utilities"){
                $("#description").append($('<option></option>').attr("value", "Building Rental").text("Building Rental"));
                $("#description").append($('<option></option>').attr("value", "Electricity Bill").text("Electricity Bill"));
                $("#description").append($('<option></option>').attr("value", "Water Bill").text("Water Bill"));
                $("#description").append($('<option></option>').attr("value", "Internet And Communication Bill").text("Internet And Communication Bill"));

                $("#qty").prop('disabled', true);
                $("#unit_price").prop('disabled', true);
                $("#qty").prop('required', false);
                $("#unit_price").prop('required', false);
            } else if(selectedCategory == "office_supply"){
                $("#description").append($('<option></option>').attr("value", "Bond Paper").text("Bond Paper"));
                $("#description").append($('<option></option>').attr("value", "Epson Ink").text("Epson Ink"));
                $("#description").append($('<option></option>').attr("value", "Whiteboard Marker").text("Whiteboard Marker"));
                $("#description").append($('<option></option>').attr("value", "Whiteboard Marker Ink").text("Whiteboard Marker Ink"));
                $("#description").append($('<option></option>').attr("value", "PVC Cover").text("PVC Cover"));
                $("#description").append($('<option></option>').attr("value", "Photo Paper").text("Photo Paper"));
                $("#description").append($('<option></option>').attr("value", "Staple Wire").text("Staple Wire"));
                $("#description").append($('<option></option>').attr("value", "Vellum").text("Vellum"));
                $("#description").append($('<option></option>').attr("value", "Ductape").text("Ductape"));
                $("#description").append($('<option></option>').attr("value", "Parchment").text("Parchment"));
                $("#description").append($('<option></option>').attr("value", "Ball Pen").text("Parchment"));
                $("#description").append($('<option></option>').attr("value", "Medal").text("Medal"));
                $("#description").append($('<option></option>').attr("value", "Notarial Seals Ribbon").text("Notarial Seals Ribbon"));
                $("#description").append($('<option></option>').attr("value", "Alcohol").text("Alcohol"));
                $("#description").append($('<option></option>').attr("value", "Air Freshener").text("Air Freshener"));
                $("#description").append($('<option></option>').attr("value", "Bathroom Cleaner").text("Bathroom Cleaner"));
                $("#description").append($('<option></option>').attr("value", "Water Refill").text("Water Refill"));

                $("#account_no").prop('disabled', true);
                $("#billing_month_from").prop('disabled', true);
                $("#billing_month_to").prop('disabled', true);
                $("#account_no").prop('required', false);
                $("#billing_month_from").prop('required', false);
                $("#billing_month_to").prop('required', false);
                $("#total_amount_due").prop('readonly', true);
            } else if(selectedCategory == "salary_and_rebates") {
                getContactPersons();

                $("#label_description").html('Contact Person');
                $("#qty").prop('disabled', true);
                $("#unit_price").prop('disabled', true);
                $("#qty").prop('required', false);
                $("#unit_price").prop('required', false);
            } else if(selectedCategory == "other_expenses"){
                $("#description").append($('<option></option>').attr("value", "Others").text("Others"));
            }
        });

        $("#qty").change(function(){
            $("#total_amount_due").val(
                $(this).val() * $("#unit_price").val() 
            );
        });

        $("#unit_price").change(function(){
            $("#total_amount_due").val(
                $(this).val() * $("#qty").val() 
            );
        });

        $("#branch_expenses").change(function(){
            if($("#category").val() == "salary_and_rebates"){
                getContactPersons();
            }
        });
    });

    function getContactPersons(){
        var userBranch = $("#branch_expenses").val();

        $.getJSON('/learning-management/api/get-branch-contact-persons/' + userBranch, function(response){
            if (response.data.length > 0) {
                $('#description').append(newOption);

                for (i = 0; i < response.data.length; i++) {
                    var newOption = $(`<option value="${response.data[i].id}">${response.data[i].fname}</option>`);
                    $('#description').append(newOption);
                }
            } else {
                var newOption = $('<option value="">No Contact Persons available</option>');
                $('#description').append(newOption);
            }
        });
    }
</script>
{% endblock %}


{% block content %}
<div class="app-main__inner">
    <div class="app-page-title" style="background-color: skyblue">
        <div class="page-title-wrapper">
            <div class="page-title-heading">
                <div class="page-title-icon">
                    <i class="{{ RENDERED_MODEL.__amicon__ }} icon-gradient bg-happy-itmeo"></i>
                </div>
                <div>
                    Fund Wallet
                    <div class="page-title-subheading">
                        Funds wallet and Expenses
                    </div>
                </div>
            </div>
            <div class="page-title-actions">
                {% if current_user.role.name in ["Admin"] %}
                    <button type="button" data-toggle="modal" data-target="#mdl_add_fund" data-placement="bottom"
                            class="btn-shadow mr-3 btn btn-primary">
                        <i class="fa fa-plus"></i> Add funds
                    </button>
                {% endif %}

                {% if current_user.role.name in ['Secretary', 'Admin'] %}
                <button type="button" data-toggle="modal" data-target="#mdl_expenses" data-placement="bottom"
                    class="btn-shadow mr-3 btn btn-primary">
                   <i class="fa fa-minus"></i> Expenses
                </button>
                {% endif %}

                <div class="d-inline-block dropdown">
                    <button type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                            class="btn-shadow dropdown-toggle btn btn-info">
                                    <span class="btn-icon-wrapper pr-2 opacity-7">
                                        <i class="fa fa-list-alt fa-w-20"></i>
                                    </span>
                        Actions
                    </button>
                    <div tabindex="-1" role="menu" aria-hidden="true" class="dropdown-menu dropdown-menu-right">
                        <ul class="nav flex-column">
                            {% if session['permissions'][RENDERED_MODEL.__amname__] is defined %}
                            {% if session['permissions'][RENDERED_MODEL.__amname__]['delete'] or current_user.is_superuser %}
                            <li id="nav_action_btns" class="nav-item">
                                {% block dropdown_buttons %}
                                <button disabled id="btndelete" type="button" tabindex="0" class="dropdown-item">Delete</button>
                                {% endblock %}
                            </li>
                            {% else %}
                            <li class="nav-item">
                                <a disabled="" href="javascript:void(0);" class="nav-link disabled">
                                    <i class="nav-link-icon lnr-file-empty"></i>
                                    <span>
                                        No actions
                                    </span>
                                </a>
                            </li>
                            {% endif %}
                            {% else %}
                            <li class="nav-item">
                                <a disabled="" href="javascript:void(0);" class="nav-link disabled">
                                    <i class="nav-link-icon lnr-file-empty"></i>
                                    <span>
                                        No actions
                                    </span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="main-card mb-3 card">
        <div class="card-header">
            {% if current_user.role.name == "Secretary" %}
                <div id="card_header_label">{{current_user.branch.name}} BRANCH</div>
            {% else %}
                <div id="card_header_label">ALL BRANCHES</div>
            {% endif %}

            {% if current_user.role.name != "Secretary" %}
            <div class="btn-actions-pane-right">
                <div class="nav">

                    <div class="dropleft btn-group">
                        <button value="all" id="btn_branch_label" type="button" aria-haspopup="true" aria-expanded="false"
                            data-toggle="dropdown" class="btn-wide mb-2 mr-2 dropdown-toggle btn btn-primary">
                            ALL BRANCHES
                        </button>
                        <div id="div_branch_buttons" tabindex="-1" role="menu" aria-hidden="true"
                            class="dropdown-menu" x-placement="left-start"
                            style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-4px, 0px, 0px);">
                            {% if current_user.role.name != "Secretary" %}
                                <button value="all" type="button" tabindex="0" class="dropdown-item btn-branch">ALL BRANCHES</button>
                            {% endif %}

                            {% for branch in branches %}
                            <button value="{{branch.id}}" type="button" tabindex="0"
                                class="dropdown-item btn-branch">{{branch.name}}</button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
        
        <div class="card-body">
            <div class="row">
                <div class="col-lg-12 col-xl-12">
                    <div class="card mb-3 widget-content">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">Fund Wallet</div>
                                <div class="widget-subheading">Running Balance</div>
                            </div>
                            <div class="widget-content-right">
                                <div class="widget-numbers text-success"><span id="total_fund_wallet">₱ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 col-xl-6">
                    <div class="card mb-3 widget-content">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">Utilities</div>
                                <div class="widget-subheading">Rental fee, Electric and Water bills</div>
                            </div>
                            <div class="widget-content-right">
                                <div class="widget-numbers text-danger"><span id="total_utilities">₱ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-xl-6">
                    <div class="card mb-3 widget-content">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">Office Supplies</div>
                                <div class="widget-subheading">Total</div>
                            </div>
                            <div class="widget-content-right">
                                <div class="widget-numbers text-danger"><span id="total_office_supplies">₱ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 col-xl-6">
                    <div class="card mb-3 widget-content">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">Salaries and Marketer Rebates</div>
                                <div class="widget-subheading">Total</div>
                            </div>
                            <div class="widget-content-right">
                                <div class="widget-numbers text-danger"><span id="total_salaries_and_rebates">₱ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-xl-6">
                    <div class="card mb-3 widget-content">
                        <div class="widget-content-wrapper">
                            <div class="widget-content-left">
                                <div class="widget-heading">Other Expenses</div>
                                <div class="widget-subheading">Total</div>
                            </div>
                            <div class="widget-content-right">
                                <div class="widget-numbers text-danger"><span id="total_other_expenses">₱ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="mb-12 card">
                <div class="card-body">
                    <ul class="tabs-animated-shadow nav-justified tabs-animated nav">
                        <li class="nav-item">
                            <a role="tab" class="nav-link show active" id="tab-c1-0" data-toggle="tab"
                                href="#tab-animated1-0" aria-selected="false">
                                <span class="nav-text">FUND WALLET STATEMENTS</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a role="tab" class="nav-link show" id="tab-c1-1" data-toggle="tab" href="#tab-animated1-1"
                                aria-selected="false">
                                <span class="nav-text">ADD FUNDS TRANSACTIONS</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a role="tab" class="nav-link show" id="tab-c1-2" data-toggle="tab" href="#tab-animated1-2"
                                aria-selected="true">
                                <span class="nav-text">EXPENSES TRANSACTIONS</span>
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane show active" id="tab-animated1-0" role="tabpanel">
                            <div style="margin-top: 10px;" class="table-responsive">
                                <table id="tbl_fund_wallet_statements"
                                    class="align-middle mb-0 table table-bordered table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">DATE</th>
                                            <th class="text-center">DESCRIPTION</th>
                                            <th class="text-center">ADD FUNDS</th>
                                            <th class="text-center">EXPENSES</th>
                                            <th class="text-center">RUNNING BALANCE</th>
                                            <th class="text-center">WHO</th>
                                            <th class="text-center">REMARKS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane show" id="tab-animated1-1" role="tabpanel">
                            <div style="margin-top: 10px;" class="table-responsive">
                                <table id="tbl_fund_wallet_transactions" class="align-middle mb-0 table table-bordered table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">DATE</th>
                                            <th class="text-center">BANK NAME / REMITTANCE CENTER</th>
                                            <th class="text-center">TRANSACTION NO.</th>
                                            <th class="text-center">SENDER</th>
                                            <th class="text-center">AMOUNT RECEIVED</th>
                                            <th class="text-center">RECEIVER</th>
                                            <th class="text-center">REMARKS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane show" id="tab-animated1-2" role="tabpanel">
                            <div style="margin-top: 10px;" class="table-responsive">
                                <table id="tbl_expenses_transactions" class="align-middle mb-0 table table-bordered table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">DATE</th>
                                            <th class="text-center">CATEGORY</th>
                                            <th class="text-center">DESCRIPTION</th>
                                            <th class="text-center">ACCOUNT NO. / PARTICULAR</th>
                                            <th class="text-center">UNIT PRICE</th>
                                            <th class="text-center">QTY</th>
                                            <th class="text-center">BILLING MONTH</th>
                                            <th class="text-center">SETTLED BY</th>
                                            <th class="text-center">TOTAL AMOUNT DUE</th>
                                            <th class="text-center">REMARKS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
